---
title: "Determine Collection-Specific Average Run Timing"
subtitle: "Correlate *lrrc9* Haplotypes to Egg-take + Aerial Surveys?"
author: "Kyle Shedd"
date: "2023-10-17; updated 2024-04-11"
output:
  html_notebook:
    theme: united
    toc: yes
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

# Objective

The objective of this R Notebook is to determine collection-specific average run timing to see how it correlates to *lrrc9* haplotypes. We'll be using the average 50% egg take date for hatchery collections (data provided by Heather Scannell, PWS Seine AMB) and average peak aerial survey stream counts for stream collections (data provided by Jenni Morella, PWS Research AMB). 

# Background

Will Hemstrom and Mark Christie at Purdue University have found a large-effect locus (*lrrc9*) for hatchery x hatchery and hatchery x natural comparisons, but not in natural x natural comparisons. Independently, and beforehand, Wes Larson and Pat Barry found strong evidence that *lrrc9* is tied to run timing in Auke Creek pink salmon. Based on their work and the pairwise Fst outlier data from Will (most of which involve VFDA hatchery, known early run timing), we have strong reason to believe that this region of the genome is associated with run timing. Here, I will be attempting to get collection-specific average run timing data (different from the collection dates in our whole genome study) that is comparable across hatchery and stream collections so we can see how run timing correlates with *lrrc9* haplotypes.

# Setup

Load all necessary packages, as of 2023-08-11 Kyle switched to [GCLr](https://github.com/commfish/GCLr).
```{r setup, message=FALSE, results='hide'}
rm(list = ls(all.names = TRUE))

if(!require("pacman")) install.packages("pacman"); library(pacman)

pacman::p_load(
  tidyverse,
  lubridate,
  scales,
  janitor,
  GCLr
)

knitr::opts_chunk$set(fig.width = 10)

# source("~/R/Functions.GCL.R")  # source GCL scripts, switched to GCLr package
.username = readLines("~/R/usr_pw.txt", n = 1)  # LOKI username
.password = readLines("~/R/usr_pw.txt" , n = 2)[[2]]  # LOKI password
```

# Import Data

## Collection Cheat Sheet

First I need to determine which collections I am dealing with.
```{r}
(
  collections <-
    readxl::read_xlsx(path = "../output/Cheat Sheet_KRS_20221213.xlsx", sheet = "collections") %>% 
    dplyr::mutate(row = dplyr::row_number()) %>% 
    dplyr::select(row, dplyr::everything())
)
```

## Individual Extraction Data

Fix date...
```{r}
(
  individuals <-
    readxl::read_excel(
      path = "../output/extraction_selection_revised_v2_20221115.xlsx",
      sheet = "individuals",
      col_types = c(
        "numeric",
        rep("text", 2),
        "numeric",
        rep("text", 3),
        "text",
        rep("text", 3),
        rep("numeric", 3),
        rep("text", 4)
      ),
      na = "NA"
    ) %>%
    dplyr::mutate(date = lubridate::as_date(
      stringr::str_sub(
        string = date,
        start = 1,
        end = 10
      )
    ))
)
```

## Egg-take

Originally: read in the egg-take data from Heather Scannell, only includes data through 2021! `data/run_timing/PWS Hatchery Performance Data - Working Data Set_hs_krs.xls`
Now: read in cleaned egg-take data from Lorna Wilson (PNP assistant coordinator). This data `output/PWS_hatchery_eggtake_cleaned_20240410.xlsx` was based on `output/PWS_hatchery_eggtake_cleaned_20240405.csv`, created in `code/hatchery_egg-take_timing_changes.Rmd` from Heather Scannell's data. Lorna made some minor updates based on what was in the PNP ADF&G database.

```{r}
(
  eggtake <-
    readxl::read_excel(
      path = "../output/PWS_hatchery_eggtake_cleaned_20240410.xlsx",
      sheet = 1,
      col_types = c(
        "text",
        "numeric",
        "text",
        rep("date", 3),
        rep("numeric", 5),
        "text",
        "numeric"
      ),
      na = "NA"
    )
)
```

Rather than give a a rolling 10 generation average p50 date (mid-point of egg-take), I'm going to give them the p50 for each sample collection year, as well as the start/stop dates. Note than egg-take follows a fairly uniform distribution (roughly the same number of eggs collected/day), rather than a normal distribution.

## Aerial Survey

I had to copy/paste the `.xlsm` into a `.csv` and change a couple of `REF` to 0
```{r}
(
  aerial <-
    readr::read_csv(file = "../data/run_timing/PWS_1962â€“2023_for Kyle.csv") %>%
    janitor::clean_names() %>%
    dplyr::mutate(
      date = lubridate::as_date(survdate, format = "%m/%d/%Y"),
      julian = lubridate::yday(date),
      lineage = dplyr::case_when(year %% 2 == 0 ~ "even",
                                 year %% 2 == 1 ~ "odd",
                                 TRUE ~ NA_character_)
    )
)
```

# Manipulate Data

## Egg-take

Rather than give a a rolling 10 generation average p50 date (mid-point of egg-take) as we've done previously, I'm going to give them the p50 for each sample collection year, as well as the start/stop dates. This will help provide context for the *lrrc9* haplotype frequencies and give an idea of how representative our samples are relative to the population. Note than egg-take follows a fairly uniform distribution (roughly the same number of eggs collected/day), rather than a normal distribution.

### VFDA

```{r}
(
  eggtake_VFDA_p50 <- eggtake %>%
    dplyr::filter(hatchery == "VFDA") %>% 
    dplyr::select(hatchery:lineage, start_julian:end_julian)
)
```

Join year-specifc egg-take dates with our VFDA collections.
```{r}
(
  VFDA_p50 <- collections %>%
    dplyr::filter(location == "VFDA") %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      eggtake_VFDA_p50 %>%
        dplyr::mutate(location = "VFDA"),
      by = c("location", "year", "lineage"),
      suffix = c("", "_eggtake")
    )
)
```

### AFK

```{r}
(
  eggtake_AFK_p50 <- eggtake %>%
    dplyr::filter(hatchery == "AFK") %>% 
    dplyr::select(hatchery:lineage, start_julian:end_julian)
)
```

Join year-specifc egg-take dates with our AFK collections.
```{r}
(
  AFK_p50 <- collections %>%
    dplyr::filter(location == "AFK") %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      eggtake_AFK_p50 %>%
        dplyr::mutate(location = "AFK"),
      by = c("location", "year", "lineage"),
      suffix = c("", "_eggtake")
    )
)
```

### CCH

```{r}
(
  eggtake_CCH_p50 <- eggtake %>%
    dplyr::filter(hatchery == "CCH") %>% 
    dplyr::select(hatchery:lineage, start_julian:end_julian)
)
```

Join year-specifc egg-take dates with our CCH collections.
```{r}
(
  CCH_p50 <- collections %>%
    dplyr::filter(location == "Cannery Creek") %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      eggtake_CCH_p50 %>%
        dplyr::mutate(location = "Cannery Creek"),
      by = c("location", "year", "lineage"),
      suffix = c("", "_eggtake")
    )
)
```

## Aerial

Get the peak count date (p50) for years with at least 3 surveys. Take a rolling 10 generation average.

### Duck

How many different "Duck River" are there?
```{r}
aerial %>% 
  dplyr::filter(grepl(x = strname, pattern = "Duck")) %>% 
  dplyr::count(strnum, strname)
```

Great, just the one. Now I need to get the p50 (peak count) date for each year.
```{r}
(
  aerial_duck_p50 <- aerial %>%
    dplyr::filter(grepl(x = strname, pattern = "Duck")) %>%
    dplyr::group_by(strname, lineage, year) %>%
    dplyr::filter(dplyr::n() >= 3) %>%
    dplyr::slice_max(pstream, with_ties = FALSE)
)
```

Vectorize to loop through all 4 Duck River collections.
```{r}
(
  duck_p50 <- collections %>%
    dplyr::filter(grepl(x = location, pattern = "Duck")) %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      aerial_duck_p50 %>%
        dplyr::mutate(location = "Duck River"),
      by = "location",
      suffix = c("", "_aerial")
    ) %>%
    dplyr::group_by(location, year, lineage) %>%
    dplyr::filter(
      lineage_aerial == lineage,
      dplyr::between(year_aerial, year - 10, year + 10)
    ) %>%
    dplyr::summarise(
      p50_julian  = mean(julian, na.rm = TRUE),
      .groups = "drop"
    )
)
```

### Erb

How many different "Erb Creek" are there?
```{r}
aerial %>% 
  dplyr::filter(grepl(x = strname, pattern = "Erb")) %>% 
  dplyr::count(strnum, strname)
```

Great, just the one. Now I need to get the p50 (peak count) date for each year.
```{r}
(
  aerial_erb_p50 <- aerial %>%
    dplyr::filter(grepl(x = strname, pattern = "Erb")) %>%
    dplyr::mutate(strname = "Erb Creek") %>% 
    dplyr::group_by(strname, lineage, year) %>%
    dplyr::filter(dplyr::n() >= 3) %>%
    dplyr::slice_max(pstream, with_ties = FALSE) %>% 
    dplyr::ungroup()
)
```

Vectorize to loop through all 4 Erb Creek collections.
```{r}
(
  erb_p50 <- collections %>%
    dplyr::filter(grepl(x = location, pattern = "Erb")) %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      aerial_erb_p50 %>%
        dplyr::mutate(location = "Erb Creek"),
      by = "location",
      suffix = c("", "_aerial")
    ) %>%
    dplyr::group_by(location, year, lineage) %>%
    dplyr::filter(
      lineage_aerial == lineage,
      dplyr::between(year_aerial, year - 10, year + 10)
    ) %>%
    dplyr::summarise(
      p50_julian  = mean(julian, na.rm = TRUE),
      .groups = "drop"
    )
)
```

### Gregorieff

How many different "Gregorieff Creek" are there?
```{r}
aerial %>% 
  dplyr::filter(grepl(x = strname, pattern = "Greg")) %>% 
  dplyr::count(strnum, strname)
```

Great, just the one. Now I need to get the p50 (peak count) date for each year.
```{r}
(
  aerial_greg_p50 <- aerial %>%
    dplyr::filter(grepl(x = strname, pattern = "Gregor")) %>%
    dplyr::mutate(strname = "Gregorieff Creek") %>% 
    dplyr::group_by(strname, lineage, year) %>%
    dplyr::filter(dplyr::n() >= 3) %>%
    dplyr::slice_max(pstream, with_ties = FALSE) %>% 
    dplyr::ungroup()
)
```

Vectorize to loop through all 4 Gregorieff Creek collections.
```{r}
(
  greg_p50 <- collections %>%
    dplyr::filter(grepl(x = location, pattern = "Gregorieff")) %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      aerial_greg_p50 %>%
        dplyr::mutate(location = "Gregorieff Creek"),
      by = "location",
      suffix = c("", "_aerial")
    ) %>%
    dplyr::group_by(location, year, lineage) %>%
    dplyr::filter(
      lineage_aerial == lineage,
      dplyr::between(year_aerial, year - 10, year + 10)
    ) %>%
    dplyr::summarise(
      p50_julian  = mean(julian, na.rm = TRUE),
      .groups = "drop"
    )
)
```

### Stockdale

How many different "Stockdale Creek" are there?
```{r}
aerial %>% 
  dplyr::filter(grepl(x = strname, pattern = "Stockdale Creek")) %>% 
  dplyr::count(strnum, strname)
```

Great, just the one. Now I need to get the p50 (peak count) date for each year.
```{r}
(
  aerial_stock_p50 <- aerial %>%
    dplyr::filter(grepl(x = strname, pattern = "Stockdale Creek")) %>%
    dplyr::mutate(strname = "Stockdale Creek") %>% 
    dplyr::group_by(strname, lineage, year) %>%
    dplyr::filter(dplyr::n() >= 3) %>%
    dplyr::slice_max(pstream, with_ties = FALSE) %>% 
    dplyr::ungroup()
)
```

Vectorize to loop through all 4 Stockdale Creek collections.
```{r}
(
  stock_p50 <- collections %>%
    dplyr::filter(grepl(x = location, pattern = "Stockdale")) %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      aerial_stock_p50 %>%
        dplyr::mutate(location = "Stockdale Creek"),
      by = "location",
      suffix = c("", "_aerial")
    ) %>%
    dplyr::group_by(location, year, lineage) %>%
    dplyr::filter(
      lineage_aerial == lineage,
      dplyr::between(year_aerial, year - 10, year + 10)
    ) %>%
    dplyr::summarise(
      p50_julian  = mean(julian, na.rm = TRUE),
      .groups = "drop"
    )
)
```

### Hogan

How many different "Hogan Creek" are there?
```{r}
aerial %>% 
  dplyr::filter(grepl(x = strname, pattern = "Hogan")) %>% 
  dplyr::count(strnum, strname)
```

Great, just the one. Now I need to get the p50 (peak count) date for each year.
```{r}
(
  aerial_hogan_p50 <- aerial %>%
    dplyr::filter(grepl(x = strname, pattern = "Hogan Bay")) %>%
    dplyr::mutate(strname = "Hogan Bay Creek") %>% 
    dplyr::group_by(strname, lineage, year) %>%
    dplyr::filter(dplyr::n() >= 3) %>%
    dplyr::slice_max(pstream, with_ties = FALSE) %>% 
    dplyr::ungroup()
)
```

Vectorize to loop through all 4 Hogan Creek collections.
```{r}
(
  hogan_p50 <- collections %>%
    dplyr::filter(grepl(x = location, pattern = "Hogan")) %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      aerial_hogan_p50 %>%
        dplyr::mutate(location = "Hogan Bay Creek"),
      by = "location",
      suffix = c("", "_aerial")
    ) %>%
    dplyr::group_by(location, year, lineage) %>%
    dplyr::filter(
      lineage_aerial == lineage,
      dplyr::between(year_aerial, year - 10, year + 10)
    ) %>%
    dplyr::summarise(
      p50_julian  = mean(julian, na.rm = TRUE),
      .groups = "drop"
    )
)
```

### Spring

How many different "Spring Creek" are there?
```{r}
aerial %>% 
  dplyr::filter(grepl(x = strname, pattern = "Spring")) %>% 
  dplyr::count(strnum, strname)
```

Great, just the one. Now I need to get the p50 (peak count) date for each year.
```{r}
(
  aerial_spring_p50 <- aerial %>%
    dplyr::filter(grepl(x = strname, pattern = "Spring"),
                  strnum == 217) %>%
    dplyr::mutate(strname = "Spring Creek") %>% 
    dplyr::group_by(strname, lineage, year) %>%
    dplyr::filter(dplyr::n() >= 3) %>%
    dplyr::slice_max(pstream, with_ties = FALSE) %>% 
    dplyr::ungroup()
)
```

Vectorize to loop through all 4 Spring Creek collections.
```{r}
(
  spring_p50 <- collections %>%
    dplyr::filter(grepl(x = location, pattern = "Spring")) %>%
    dplyr::select(location, silly, year, lineage) %>%
    dplyr::left_join(
      aerial_spring_p50 %>%
        dplyr::mutate(location = "Spring Creek"),
      by = "location",
      suffix = c("", "_aerial")
    ) %>%
    dplyr::group_by(location, year, lineage) %>%
    dplyr::filter(
      lineage_aerial == lineage,
      dplyr::between(year_aerial, year - 10, year + 10)
    ) %>%
    dplyr::summarise(
      p50_julian  = mean(julian, na.rm = TRUE),
      .groups = "drop"
    )
)
```

# Bind

Bind together all of the egg-take and aerial survey data.
```{r}
(
  p50 <- dplyr::bind_rows(
    VFDA_p50,
    AFK_p50,
    CCH_p50,
    duck_p50,
    erb_p50,
    greg_p50,
    stock_p50,
    hogan_p50,
    spring_p50
  )
)
```

# Collection/Individual Dates

Get the average date for each collection based on individual data.
```{r}
(
  colletions_indiv_avg_date <- individuals %>%
    dplyr::mutate(
      julian = lubridate::yday(date),
      year = lubridate::year(date),
      year = dplyr::case_when(
        silly == "PAFK94H" ~ 1994,
        silly == "PGREG94" ~ 1994,
        silly == "PSTOCK16" ~ 2016,
        silly == "PVFDA14" ~ 2014,
        TRUE ~ year
      ),
      lineage = dplyr::case_when(year %% 2 == 0 ~ "even",
                                 year %% 2 == 1 ~ "odd",
                                 TRUE ~ NA_character_),
      location_type = dplyr::case_when(
        silly %in% c(
          "PAFK94H",
          "PAFK14",
          "PAFK91H",
          "PAFK13",
          "PCANN14",
          "PCANN91H",
          "PCANN15",
          "PVFDA94H",
          "PVFDA14",
          "PVFDE91H",
          "PVFDA15"
        ) ~ "hatchery",
        silly %in% c(
          "PDUCK94T",
          "PDUCK14E",
          "PDUCK14L",
          "PERBE91T",
          "PERBL91T",
          "PERB17",
          "PGREG94",
          "PGREG14E",
          "PGREG14L",
          "PDUCM91T",
          "PDUCK13"
        ) ~ "source",
        silly == "PSTOCK16" & origin == "hatchery" ~ "stray",
        silly == "PSTOCK16" & origin == "natural" ~ "wild",
        silly == "PSTOCK15" & origin == "hatchery" ~ "stray",
        silly == "PSTOCK15" & origin == "natural" ~ "wild",
        silly == "PHOGAN16" & origin == "hatchery" ~ "stray",
        silly == "PHOGAN16" & origin == "natural" ~ "wild",
        silly == "PHOGAN15" & origin == "hatchery" ~ "stray",
        silly == "PHOGAN15" & origin == "natural" ~ "wild",
        silly %in% c("PSPRIN14", "PSPRIN15") ~ "wild",
        TRUE ~ NA_character_
      )
    ) %>%
    dplyr::left_join(
      y = collections %>% dplyr::select(1:6, silly),
      by = c("silly", "location_type")
    ) %>%
    dplyr::select(
      row,
      sample_unit_no,
      objective,
      silly,
      location,
      location_descriptor,
      dplyr::everything()
    ) %>%
    dplyr::group_by(
      row,
      sample_unit_no,
      objective,
      silly,
      year,
      lineage,
      location,
      location_type,
      location_descriptor
    ) %>%
    dplyr::summarise(
      collection_julian = mean(julian, na.rm = TRUE),
      .groups = "drop"
    )
)
```

# Join Egg-take & Aerial

Join in the individual level average dates with the aerial survey and p50 egg-take 20 year rolling average dates.
```{r}
(
  run_timing <- colletions_indiv_avg_date %>%
    dplyr::left_join(y = p50 %>% dplyr::select(-silly, -hatchery), by = c("location", "year", "lineage"))
)
```

# Write Output

Output has:  

    `collection_julian` = the average collection date (some collections are from a single date, others the whole season, up to 42 days)
    `start_julian` = first day of egg-take in the hatchery for that year
    `p50_julian` = either 1) mid-point of egg-take in the hatchery for that year, note that egg-take is fairly uniform (i.e. same number of eggs each day), or 2) 10-generation rolling average of peak aerial survey count for years w/ >= 3 surveys, note aerial survey data has lots of caveats (weather delays, etc.)
    `end_julian` = last day of egg-take in the hatchery for that year

This is different than what I'd previously provided.
```{r}
 run_timing %>%
    readr::write_csv(file = "../output/run_timing.csv")
```

Going to go into this and manually add notes and a README and save as an `.xlsx`.

# Conclusions

Sometimes, our hatchery collections came from the beginning or end of egg-take in a given year.

End