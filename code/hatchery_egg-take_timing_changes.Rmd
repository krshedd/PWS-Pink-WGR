---
title: "Variation in PWS Pink Salmon Egg-Take Over Time"
subtitle: "Has Egg-Take Timing Shifted?"
author: "Kyle Shedd"
date: "2024-03-26"
output:
  html_notebook:
    theme: united
    toc: yes
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

# Objective

The objective of this R Notebook is to determine whether egg-take date for hatchery collections (data provided by Heather Scannell, PWS Seine AMB) has contracted over time. 

# Background

Will Hemstrom and Mark Christie at Purdue University have found a large-effect locus (*lrrc9*) for hatchery x hatchery and hatchery x natural comparisons, but not in natural x natural comparisons. Independently, and beforehand, Wes Larson and Pat Barry found strong evidence that *lrrc9* is tied to run timing in Auke Creek pink salmon. Based on their work and the pairwise Fst outlier data from Will (most of which involve VFDA hatchery, known early run timing), we have strong reason to believe that this region of the genome is associated with run timing. Here, I will be attempting to get collection-specific run timing data that is comparable across hatchery and stream collections so we can see how run timing correlates with *lrrc9* haplotypes.

# Setup

Load all necessary packages, as of 2023-08-11 Kyle switched to [GCLr](https://github.com/commfish/GCLr).
```{r setup, message=FALSE, results='hide'}
rm(list = ls(all.names = TRUE))

if(!require("pacman")) install.packages("pacman"); library(pacman)

pacman::p_load(
  tidyverse,
  lubridate,
  scales,
  janitor,
  GCLr
)

knitr::opts_chunk$set(fig.width = 10)

# source("~/R/Functions.GCL.R")  # source GCL scripts, switched to GCLr package
.username = readLines("~/R/usr_pw.txt", n = 1)  # LOKI username
.password = readLines("~/R/usr_pw.txt" , n = 2)[[2]]  # LOKI password
```

# Import Data

## Egg-take

Read in the egg-take data from Heather Scannell, only includes data through 2021!

### VFDA

**NOTE** dates are ALL formatted as 2010, need to look into how to strip out M/D and then rejoin with `year`, and then extract the Julian date (`yday`).
```{r}
(
  eggtake_VFDA <-
    readxl::read_xls(
      path = "../data/run_timing/PWS Hatchery Performance Data - Working Data Set_hs_krs.xls",
      sheet = "VFDA Fecundity Data",
      range = "A3:N44",
      col_types = c(
        "numeric",
        rep("text", 2),
        rep("numeric", 5),
        "skip",
        rep("date", 3),
        rep("numeric", 2)
      )
    ) %>% janitor::clean_names() %>% 
    dplyr::mutate(start_date = lubridate::as_date(egg_take_start),
                  end_date = lubridate::as_date(egg_take_end_date),
                  p50_date = lubridate::as_date(x50_percent_egg_take_date)) %>% 
    dplyr::select(-egg_take_start, -egg_take_end_date, -x50_percent_egg_take_date)
)
```

### AFK

**NOTE** dates are ALL formatted as 2010, need to look into how to strip out M/D and then rejoin with `year`, and then extract the Julian date (`yday`).
```{r}
(
  eggtake_AFK <-
    readxl::read_xls(
      path = "../data/run_timing/PWS Hatchery Performance Data - Working Data Set_hs_krs.xls",
      sheet = "AFK Fecundity Data",
      range = "A3:K51",
      col_types = c(
        "numeric",
        rep("text", 2),
        rep("numeric", 4),
        rep("date", 3),
        "numeric"
      )
    ) %>% janitor::clean_names() %>% 
    dplyr::mutate(start_date = lubridate::as_date(egg_take_start),
                  end_date = lubridate::as_date(egg_take_end_date),
                  p50_date = lubridate::as_date(x50_percent_egg_take_date),
                  p50_julian = lubridate::yday(p50_date)) %>% 
    dplyr::select(-egg_take_start, -egg_take_end_date, -x50_percent_egg_take_date)
)
```

### WNH

**NOTE** dates are mostly formatted as 2010, need to look into how to strip out M/D and then rejoin with `year`, and then extract the Julian date (`yday`).
```{r}
(
  eggtake_WNH <-
    readxl::read_xls(
      path = "../data/run_timing/PWS Hatchery Performance Data - Working Data Set_hs_krs.xls",
      sheet = "WNH Fecundity Data",
      range = "A2:N31",
      col_types = c(
        "numeric",
        rep("text", 2),
        rep("numeric", 5),
        "text",
        rep("date", 3),
        rep("numeric", 2)
      )
    ) %>% janitor::clean_names() %>% 
    dplyr::mutate(start_date = lubridate::as_date(egg_take_start),
                  end_date = lubridate::as_date(egg_take_end_date),
                  p50_date = lubridate::as_date(x50_percent_egg_take_date),
                  p50_julian = lubridate::yday(p50_date)) %>% 
    dplyr::select(-egg_take_start, -egg_take_end_date, -x50_percent_egg_take_date, -x9)
)
```

### CCH

**NOTE** dates are mostly formatted as 2010, need to look into how to strip out M/D and then rejoin with `year`, and then extract the Julian date (`yday`).
```{r}
(
  eggtake_CCH <-
    readxl::read_xls(
      path = "../data/run_timing/PWS Hatchery Performance Data - Working Data Set_hs_krs.xls",
      sheet = "CCH Fecundity Data",
      range = "A3:N50",
      col_types = c(
        "numeric",
        rep("text", 2),
        rep("numeric", 6),
        rep("date", 3),
        rep("numeric", 2)
      )
    ) %>% janitor::clean_names() %>% 
    dplyr::mutate(start_date = lubridate::as_date(egg_take_start),
                  end_date = lubridate::as_date(egg_take_end_date),
                  p50_date = lubridate::as_date(x50_percent_egg_take_date),
                  p50_julian = lubridate::yday(p50_date)) %>% 
    dplyr::select(-egg_take_start, -egg_take_end_date, -x50_percent_egg_take_date)
)
```

# Manipulate Data

## Egg-take

### VFDA

Fix dates to correct year, calculate Julian date for p50 egg take for each year.
```{r}
(
  eggtake_VFDA_clean <- eggtake_VFDA %>%
    dplyr::mutate(
      p50_date = as.character(p50_date),
      p50_date = stringr::str_sub(
        string = p50_date,
        start = 6,
        end = -1
      ),
      p50_date = stringr::str_c(year, p50_date, sep = "-"),
      p50_date = lubridate::as_date(p50_date),
      p50_julian = lubridate::yday(p50_date),
      start_date = as.character(start_date),
      start_date = stringr::str_sub(
        string = start_date,
        start = 6,
        end = -1
      ),
      start_date = stringr::str_c(year, start_date, sep = "-"),
      start_date = lubridate::as_date(start_date),
      start_julian = lubridate::yday(start_date),
      end_date = as.character(end_date),
      end_date = stringr::str_sub(
        string = end_date,
        start = 6,
        end = -1
      ),
      end_date = stringr::str_c(year, end_date, sep = "-"),
      end_date = lubridate::as_date(end_date),
      end_julian = lubridate::yday(end_date),
      duration = end_date - start_date,
      lineage = dplyr::case_when(year %% 2 == 0 ~ "even",
                                 year %% 2 == 1 ~ "odd",
                                 TRUE ~ NA_character_)
    ) %>%
    dplyr::select(hatchery, year, lineage, start_date, p50_date, end_date, start_julian, p50_julian, end_julian, duration, fecundity)
)
```

### AFK

Fix dates to correct year, calculate Julian date for p50 egg take for each year.
```{r}
(
  eggtake_AFK_clean <- eggtake_AFK %>%
    dplyr::mutate(
      p50_date = as.character(p50_date),
      p50_date = stringr::str_sub(
        string = p50_date,
        start = 6,
        end = -1
      ),
      p50_date = stringr::str_c(year, p50_date, sep = "-"),
      p50_date = lubridate::as_date(p50_date),
      p50_julian = lubridate::yday(p50_date),
      start_date = as.character(start_date),
      start_date = stringr::str_sub(
        string = start_date,
        start = 6,
        end = -1
      ),
      start_date = stringr::str_c(year, start_date, sep = "-"),
      start_date = lubridate::as_date(start_date),
      start_julian = lubridate::yday(start_date),
      end_date = as.character(end_date),
      end_date = stringr::str_sub(
        string = end_date,
        start = 6,
        end = -1
      ),
      end_date = stringr::str_c(year, end_date, sep = "-"),
      end_date = lubridate::as_date(end_date),
      end_julian = lubridate::yday(end_date),
      duration = end_date - start_date,
      lineage = dplyr::case_when(year %% 2 == 0 ~ "even",
                                 year %% 2 == 1 ~ "odd",
                                 TRUE ~ NA_character_)
    ) %>%
    dplyr::select(hatchery, year, lineage, start_date, p50_date, end_date, start_julian, p50_julian, end_julian, duration, fecundity)
)
```

### WNH

Fix dates to correct year, calculate Julian date for p50 egg take for each year.
```{r}
(
  eggtake_WNH_clean <- eggtake_WNH %>%
    dplyr::mutate(
      p50_date = as.character(p50_date),
      p50_date = stringr::str_sub(
        string = p50_date,
        start = 6,
        end = -1
      ),
      p50_date = stringr::str_c(year, p50_date, sep = "-"),
      p50_date = lubridate::as_date(p50_date),
      p50_julian = lubridate::yday(p50_date),
      start_date = as.character(start_date),
      start_date = stringr::str_sub(
        string = start_date,
        start = 6,
        end = -1
      ),
      start_date = stringr::str_c(year, start_date, sep = "-"),
      start_date = lubridate::as_date(start_date),
      start_julian = lubridate::yday(start_date),
      end_date = as.character(end_date),
      end_date = stringr::str_sub(
        string = end_date,
        start = 6,
        end = -1
      ),
      end_date = stringr::str_c(year, end_date, sep = "-"),
      end_date = lubridate::as_date(end_date),
      end_julian = lubridate::yday(end_date),
      duration = end_date - start_date,
      lineage = dplyr::case_when(year %% 2 == 0 ~ "even",
                                 year %% 2 == 1 ~ "odd",
                                 TRUE ~ NA_character_)
    ) %>%
    dplyr::select(hatchery, year, lineage, start_date, p50_date, end_date, start_julian, p50_julian, end_julian, duration, fecundity)
)
```

### CCH

Fix dates to correct year, calculate Julian date for p50 egg take for each year.
```{r}
(
  eggtake_CCH_clean <- eggtake_CCH %>%
    dplyr::mutate(
      p50_date = as.character(p50_date),
      p50_date = stringr::str_sub(
        string = p50_date,
        start = 6,
        end = -1
      ),
      p50_date = stringr::str_c(year, p50_date, sep = "-"),
      p50_date = lubridate::as_date(p50_date),
      p50_julian = lubridate::yday(p50_date),
      start_date = as.character(start_date),
      start_date = stringr::str_sub(
        string = start_date,
        start = 6,
        end = -1
      ),
      start_date = stringr::str_c(year, start_date, sep = "-"),
      start_date = lubridate::as_date(start_date),
      start_julian = lubridate::yday(start_date),
      end_date = as.character(end_date),
      end_date = stringr::str_sub(
        string = end_date,
        start = 6,
        end = -1
      ),
      end_date = stringr::str_c(year, end_date, sep = "-"),
      end_date = lubridate::as_date(end_date),
      end_julian = lubridate::yday(end_date),
      duration = end_date - start_date,
      lineage = dplyr::case_when(year %% 2 == 0 ~ "even",
                                 year %% 2 == 1 ~ "odd",
                                 TRUE ~ NA_character_)
    ) %>%
    dplyr::select(hatchery, year, lineage, start_date, p50_date, end_date, start_julian, p50_julian, end_julian, duration, fecundity)
)
```

### Bind

```{r}
eggtake_clean <- dplyr::bind_rows(eggtake_AFK_clean, eggtake_WNH_clean, eggtake_CCH_clean, eggtake_VFDA_clean)
```

# Plot

Plot start/stop egg-take dates over time as ribbon charts.
```{r}
eggtake_p50_mean <- eggtake_clean %>% 
  dplyr::mutate(lineage = stringr::str_to_sentence(lineage),
                hatchery = factor(x = hatchery, levels = c("VFDA", "AFK", "WNH", "CCH"))) %>% 
  dplyr::group_by(hatchery, lineage) %>% 
  dplyr::summarise(mean_p50 = mean(p50_julian, na.rm = TRUE), .groups = "drop")

eggtake_clean %>% 
  dplyr::mutate(lineage = stringr::str_to_sentence(lineage),
                hatchery = factor(x = hatchery, levels = c("VFDA", "AFK", "WNH", "CCH"))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = year, ymin = start_julian, y = p50_julian, ymax = end_julian, fill = lineage)) +
  ggplot2::geom_ribbon(alpha = 0.7) +
  ggplot2::geom_line(lwd = 1) +
  ggplot2::geom_hline(data = eggtake_p50_mean, ggplot2::aes(yintercept = mean_p50), lwd = 1, lty = 2) +
  # ggplot2::geom_smooth(method = "lm", se = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::labs(x = "Brood Year", y = "Day of Year", fill = "Lineage", title = "PWS Pink Salmon: Timing of Egg-Take by Hatchery x Lineage") +
  ggplot2::facet_grid(rows = dplyr::vars(lineage), cols = dplyr::vars(hatchery))
```

```{r}
eggtake_duration_mean <- eggtake_clean %>% 
  dplyr::mutate(lineage = stringr::str_to_sentence(lineage),
                hatchery = factor(x = hatchery, levels = c("VFDA", "AFK", "WNH", "CCH"))) %>% 
  dplyr::group_by(hatchery, lineage) %>% 
  dplyr::summarise(mean_duration = mean(duration, na.rm = TRUE), .groups = "drop")

eggtake_clean %>% 
  dplyr::mutate(lineage = stringr::str_to_sentence(lineage),
                hatchery = factor(x = hatchery, levels = c("VFDA", "AFK", "WNH", "CCH"))) %>% 
  ggplot2::ggplot(ggplot2::aes(x = year, y = duration, colour = lineage)) +
  ggplot2::geom_line(lwd = 1) +
  ggplot2::geom_hline(data = eggtake_duration_mean, ggplot2::aes(yintercept = mean_duration), lwd = 1, lty = 2) +
  ggplot2::geom_smooth(method = "lm", lty = 1) +
  ggplot2::theme_bw() +
  ggplot2::labs(x = "Brood Year", y = "Duration of Egg-Take (Days)", colour = "Lineage", title = "PWS Pink Salmon: Duration of Egg-Take by Hatchery x Lineage") +
  ggplot2::facet_grid(rows = dplyr::vars(lineage), cols = dplyr::vars(hatchery))
```

# Conclusion

It certainly looks like VFDA has pushed their run later over time, in both lineage. No major changes in median run timing at the 3 PWSAC hatcheries. However, there has been a contraction in the duration of egg-take at all three PWSAC hatcheries, more pronounced in the odd-lineage than the even-lineage.